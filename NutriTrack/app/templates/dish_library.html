{% extends "base.html" %}

{% block title %}菜品库{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3"><i class="fas fa-utensils me-2"></i>菜品库</h2>
            <p class="text-muted">以下是系统中所有可用的菜品及其营养信息</p>
        </div>
    </div>

    <!-- 菜品搜索和筛选 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="dishSearch" placeholder="搜索菜品名称...">
                    </div>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="sortOptions">
                        <option value="name">按名称排序</option>
                        <option value="calories">按热量排序</option>
                        <option value="protein">按蛋白质排序</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- 菜品列表 -->
    <div class="row" id="dishContainer">
        {% for item in dishes %}
        <div class="col-lg-4 col-md-6 mb-4 dish-item" data-name="{{ item.dish.name.lower() }}"
            data-calories="{{ item.nutrition.calories }}" data-protein="{{ item.nutrition.protein }}">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title mb-0">{{ item.dish.name }}</h5>
                        {% if item.dish.cooking_method %}
                        <span class="badge bg-primary">{{ item.dish.cooking_method }}</span>
                        {% else %}
                        <span class="badge bg-secondary">未知</span>
                        {% endif %}
                    </div>

                    <!-- 营养信息概览 -->
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="small text-muted">热量</div>
                            <div class="fw-bold text-success">{{ item.nutrition.calories }}<small>kcal</small></div>
                        </div>
                        <div class="col-3">
                            <div class="small text-muted">蛋白质</div>
                            <div class="fw-bold">{{ item.nutrition.protein }}<small>g</small></div>
                        </div>
                        <div class="col-3">
                            <div class="small text-muted">脂肪</div>
                            <div class="fw-bold">{{ item.nutrition.fat }}<small>g</small></div>
                        </div>
                        <div class="col-3">
                            <div class="small text-muted">碳水</div>
                            <div class="fw-bold">{{ item.nutrition.carb }}<small>g</small></div>
                        </div>
                    </div>

                    <!-- 每100g营养详情 -->
                    <div class="mt-3 small">
                        <div class="d-flex justify-content-between">
                            <span>每100g营养成分：</span>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span>热量：</span>
                            <span class="text-success">{{ item.nutrition.calories }} kcal</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>蛋白质：</span>
                            <span>{{ item.nutrition.protein }} g</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>脂肪：</span>
                            <span>{{ item.nutrition.fat }} g</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>碳水化合物：</span>
                            <span>{{ item.nutrition.carb }} g</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 无结果提示 -->
    <div class="text-center py-5" id="noResults" style="display: none;">
        <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">未找到相关菜品</h4>
        <p class="text-muted">请尝试其他关键词搜索</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 搜索功能
    document.getElementById('dishSearch').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const dishItems = document.querySelectorAll('.dish-item');
        let hasResults = false;

        dishItems.forEach(item => {
            const dishName = item.getAttribute('data-name');
            if (dishName.includes(searchTerm)) {
                item.style.display = 'block';
                hasResults = true;
            } else {
                item.style.display = 'none';
            }
        });

        // 显示/隐藏无结果提示
        document.getElementById('noResults').style.display = hasResults ? 'none' : 'block';
    });

    // 排序功能
    document.getElementById('sortOptions').addEventListener('change', function () {
        const sortBy = this.value;
        const container = document.getElementById('dishContainer');
        const dishItems = Array.from(container.querySelectorAll('.dish-item'));

        dishItems.sort((a, b) => {
            let aValue, bValue;

            switch (sortBy) {
                case 'name':
                    aValue = a.getAttribute('data-name');
                    bValue = b.getAttribute('data-name');
                    return aValue.localeCompare(bValue);
                case 'calories':
                    aValue = parseFloat(a.getAttribute('data-calories')) || 0;
                    bValue = parseFloat(b.getAttribute('data-calories')) || 0;
                    return bValue - aValue; // 降序
                case 'protein':
                    aValue = parseFloat(a.getAttribute('data-protein')) || 0;
                    bValue = parseFloat(b.getAttribute('data-protein')) || 0;
                    return bValue - aValue; // 降序
                default:
                    return 0;
            }
        });

        // 重新排列元素
        dishItems.forEach(item => container.appendChild(item));
    });
</script>
{% endblock %}