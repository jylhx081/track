{% extends "base.html" %}

{% block title %}用餐追踪{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3"><i class="fas fa-utensils me-2"></i>用餐追踪</h2>
        </div>
    </div>

    <!-- 取餐监控区域 -->
    <div class="card mb-5">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-bold">取餐监控</h5>
            <div class="d-flex align-items-center">
                <span class="me-3">状态: <span class="text-success fw-bold">正在取餐</span></span>
                <button class="btn btn-outline-secondary btn-sm" id="pauseBtn">暂停取餐</button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 border-end">
                    <h6 class="text-muted mb-3">重量变化记录</h6>
                    <div class="list-group list-group-flush" id="weightLog" style="height: 300px; overflow-y: auto;">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">12:05</span>
                            <span class="text-success fw-bold">+120g</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span class="text-muted">12:07</span>
                            <span class="text-success fw-bold">+80g</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h6 class="text-muted mb-3">实时重量图表</h6>
                    <div style="height: 300px;">
                        <canvas id="weightChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-success btn-lg px-5" id="finishMealBtn">
                    <i class="fas fa-check-circle me-2"></i>完成取餐
                </button>
            </div>
        </div>
    </div>

    <!-- 菜品识别区域 -->
    <div class="card mb-4">
        <div class="card-header"><i class="fas fa-camera me-2"></i>菜品识别与营养计算</div>
        <div class="card-body">
            <div class="row">
                <!-- 左侧：上传/拍照区域 -->
                <div class="col-md-6">
                    <h5 class="mb-3">上传餐盘图片</h5>
                    <div class="text-center mb-4">
                        <!-- 图片预览区域 -->
                        <div id="imagePreview" class="border border-dashed border-2 rounded-3 p-4 mb-3" style="height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;">
                            <i class="fas fa-camera fa-3x text-muted mb-2"></i>
                            <p class="text-muted">点击拍照或上传图片</p>
                            <p class="text-xs text-muted">请拍摄清晰、无遮挡的餐盘全景</p>
                            <input type="file" id="dishImage" accept="image/*" style="display: none;" onchange="previewImage(this)">
                            
                            <!-- 摄像头视频区域 -->
                            <video id="video" width="100%" style="max-width: 400px; border-radius: 8px; display:none;" autoplay></video>
                            <canvas id="canvas" style="display:none;"></canvas>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="d-flex justify-content-center gap-3">
                            <button class="btn btn-outline-primary" id="cameraBtn" onclick="toggleCamera()">
                                <i class="fas fa-camera me-1"></i>拍照
                            </button>
                            <button class="btn btn-outline-secondary" onclick="document.getElementById('dishImage').click()">
                                <i class="fas fa-upload me-1"></i>上传
                            </button>
                        </div>
                        
                        <!-- 拍照按钮（仅在摄像头开启时显示） -->
                        <button class="btn btn-primary mt-3" id="captureBtn" style="display:none;" onclick="captureAndDetect()">
                            <i class="fas fa-camera me-1"></i>拍摄并识别
                        </button>
                    </div>
                </div>
                
                <!-- 右侧：识别结果区域 -->
                <div class="col-md-6">
                    <h5 class="mb-3">识别结果</h5>
                    <div id="detectionResults" class="mb-4" style="min-height: 300px;">
                        <!-- 识别结果将在这里动态生成 -->
                        <div id="emptyResults" class="text-center text-muted py-5">
                            <i class="fas fa-search fa-3x mb-2"></i>
                            <p>暂无识别结果</p>
                            <p class="text-xs">请上传或拍摄餐盘图片进行识别</p>
                        </div>
                        <div id="resultsContainer" style="display: none;">
                            <!-- 动态生成的菜品卡片 -->
                        </div>
                    </div>
                    
                    <!-- 确认按钮 -->
                    <div class="text-center">
                        <button class="btn btn-success btn-lg" id="confirmResultsBtn" style="display: none;" onclick="showNutritionSummary()">
                            <i class="fas fa-check me-2"></i>确认识别结果
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 营养总结和保存区域（默认隐藏） -->
            <div id="nutritionSummary" class="mt-5" style="display: none;">
                <div class="card bg-light border-0">
                    <div class="card-body">
                        <h5 class="card-title text-success mb-4">营养总览</h5>
                        <div class="row mb-4">
                            <div class="col-md-3 text-center">
                                <div class="fs-3 fw-bold text-success"><span id="totalCal">0.0</span> kcal</div>
                                <div class="text-muted">总热量</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="fs-3 fw-bold"><span id="totalProt">0.0</span> g</div>
                                <div class="text-muted">蛋白质</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="fs-3 fw-bold"><span id="totalFat">0.0</span> g</div>
                                <div class="text-muted">脂肪</div>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="fs-3 fw-bold"><span id="totalCarb">0.0</span> g</div>
                                <div class="text-muted">碳水化合物</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="mealType" class="form-label">用餐时段</label>
                                <select class="form-select" id="mealType">
                                    <option value="1">早餐</option>
                                    <option value="2">午餐</option>
                                    <option value="3">晚餐</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button class="btn btn-success w-100 py-2" onclick="saveRecord()">
                                    <i class="fas fa-save me-2"></i>保存用餐记录
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 引入Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // ========== 重量图表初始化 ==========
    const weightCtx = document.getElementById('weightChart').getContext('2d');
    const weightChart = new Chart(weightCtx, {
        type: 'line',
        data: {
            labels: ['12:00', '12:05', '12:07', '12:09', '12:10'],
            datasets: [{
                label: '重量 (g)',
                data: [0, 120, 200, 250, 350],
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // ========== 摄像头逻辑 ==========
    let videoStream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const imagePreview = document.getElementById('imagePreview');

    // 切换摄像头状态
    async function toggleCamera() {
        if (videoStream) {
            // 关闭摄像头
            stopCamera();
            cameraBtn.innerHTML = '<i class="fas fa-camera me-1"></i>拍照';
        } else {
            // 开启摄像头
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = videoStream;
                video.style.display = 'block';
                captureBtn.style.display = 'inline-block';
                cameraBtn.innerHTML = '<i class="fas fa-times me-1"></i>关闭摄像头';
                
                // 隐藏默认预览
                const previewElements = imagePreview.querySelectorAll('i, p');
                previewElements.forEach(el => el.style.display = 'none');
            } catch (err) {
                alert("无法访问摄像头，请检查权限或确保摄像头未被占用！");
                console.error("摄像头错误：", err);
            }
        }
    }

    // 关闭摄像头
    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            
            // 恢复默认预览
            const previewElements = imagePreview.querySelectorAll('i, p');
            previewElements.forEach(el => el.style.display = 'block');
        }
    }

    // 图片预览
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            // 关闭摄像头（如果开启）
            stopCamera();
            cameraBtn.innerHTML = '<i class="fas fa-camera me-1"></i>拍照';
            
            // 隐藏默认预览
            const previewElements = imagePreview.querySelectorAll('i, p');
            previewElements.forEach(el => el.style.display = 'none');
            
            // 创建预览图片
            reader.onload = function(e) {
                // 移除之前的预览图片
                const existingImg = imagePreview.querySelector('img');
                if (existingImg) {
                    existingImg.remove();
                }
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '280px';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '8px';
                imagePreview.appendChild(img);
                
                // 识别菜品
                detectDish('upload');
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 拍照并识别
    function captureAndDetect() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        canvas.toBlob(function (blob) {
            detectDish('camera', blob);
        }, 'image/jpeg');
    }

    // ========== 菜品识别核心逻辑 ==========
    let currentDishes = [];  // 存储当前识别的菜品
    let nutritionTotals = {  // 存储总营养数据
        calories: 0.0,
        protein: 0.0,
        fat: 0.0,
        carb: 0.0
    };

    // 识别菜品
    function detectDish(source, blob = null) {
        const formData = new FormData();

        // 上传图片方式
        if (source === 'upload') {
            const fileInput = document.getElementById('dishImage');
            if (fileInput.files.length === 0) {
                alert('请先选择要识别的图片！');
                return;
            }
            formData.append('image', fileInput.files[0]);
        }
        // 摄像头拍照方式
        else {
            if (!blob) {
                alert('拍照失败，请重试！');
                return;
            }
            formData.append('image', blob, 'capture.jpg');
        }

        // 发送识别请求
        fetch("{{ url_for('meal_track.detect_dish') }}", {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // 渲染识别结果
                    displayResults(data.results);
                } else {
                    alert('菜品识别失败：' + data.message);
                }
            })
            .catch(err => {
                alert('识别请求失败，请检查网络或服务器！');
                console.error("识别请求错误：", err);
            });
    }

    // 渲染识别结果到卡片
    function displayResults(results) {
        const resultsContainer = document.getElementById('resultsContainer');
        resultsContainer.innerHTML = '';
        currentDishes = results;

        // 遍历结果生成卡片
        results.forEach((dish, index) => {
            // 根据菜品类型选择图标
            let iconClass = '';
            let iconColor = '';
            if (dish.dish_name.includes('米饭') || dish.dish_name.includes('面') || dish.dish_name.includes('粉')) {
                iconClass = 'fas fa-bread-slice';
                iconColor = 'text-warning';
            } else if (dish.dish_name.includes('菜') || dish.dish_name.includes('汤')) {
                iconClass = 'fas fa-leaf';
                iconColor = 'text-success';
            } else if (dish.dish_name.includes('肉') || dish.dish_name.includes('鱼') || dish.dish_name.includes('蛋')) {
                iconClass = 'fas fa-drumstick-bite';
                iconColor = 'text-danger';
            } else {
                iconClass = 'fas fa-utensils';
                iconColor = 'text-info';
            }

            const card = `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-full p-2 me-3">
                                    <i class="${iconClass} ${iconColor} fa-lg"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${dish.dish_name}</h6>
                                    <div class="text-xs text-muted">置信度 ${(dish.confidence * 100).toFixed(1)}%</div>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <div class="input-group" style="width: 120px;">
                                    <input type="number" 
                                           class="form-control form-control-sm" 
                                           value="${dish.weight}" 
                                           min="1"
                                           onchange="updateWeight(${index}, this.value)">
                                    <span class="input-group-text">g</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeDish(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.innerHTML += card;
        });

        // 显示结果区域
        document.getElementById('emptyResults').style.display = 'none';
        resultsContainer.style.display = 'block';
        document.getElementById('confirmResultsBtn').style.display = 'inline-block';
    }

    // 更新菜品重量
    function updateWeight(index, value) {
        // 验证重量有效性
        const weight = parseFloat(value);
        if (isNaN(weight) || weight <= 0) {
            alert('重量必须是大于0的数字！');
            // 恢复原数值
            const inputs = document.querySelectorAll('#resultsContainer input');
            if (inputs[index]) {
                inputs[index].value = currentDishes[index].weight;
            }
            return;
        }
        // 更新重量
        currentDishes[index].weight = weight;
    }

    // 删除菜品
    function removeDish(index) {
        currentDishes.splice(index, 1);
        // 重新渲染卡片
        displayResults(currentDishes);
        
        // 如果没有菜品了，隐藏确认按钮
        if (currentDishes.length === 0) {
            document.getElementById('confirmResultsBtn').style.display = 'none';
            document.getElementById('emptyResults').style.display = 'flex';
            document.getElementById('resultsContainer').style.display = 'none';
        }
    }

    // 显示营养总结
    function showNutritionSummary() {
        // 计算营养数据
        calculateNutrition(currentDishes);
        
        // 显示营养总结区域
        document.getElementById('nutritionSummary').style.display = 'block';
        
        // 滚动到营养总结区域
        document.getElementById('nutritionSummary').scrollIntoView({ behavior: 'smooth' });
    }

    // 计算营养数据（调用后端接口）
    function calculateNutrition(dishes) {
        fetch("{{ url_for('meal_track.calculate_nutrition') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ dishes: dishes })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    alert('营养计算失败：' + (data.message || '未知错误'));
                    return;
                }

                // 更新总营养数据
                nutritionTotals = data.total;
                document.getElementById('totalCal').innerText = nutritionTotals.calories.toFixed(1);
                document.getElementById('totalProt').innerText = nutritionTotals.protein.toFixed(1);
                document.getElementById('totalFat').innerText = nutritionTotals.fat.toFixed(1);
                document.getElementById('totalCarb').innerText = nutritionTotals.carb.toFixed(1);
            })
            .catch(err => {
                alert('营养计算请求失败，请重试！');
                console.error("营养计算错误：", err);
            });
    }

    // 保存用餐记录
    function saveRecord() {
        if (currentDishes.length === 0) {
            alert('暂无菜品数据，无法保存记录！');
            return;
        }

        fetch("{{ url_for('meal_track.save_meal_record') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                meal_type: document.getElementById('mealType').value,
                dish_list: currentDishes,
                totals: nutritionTotals
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('用餐记录保存成功！');
                    // 重置页面状态
                    currentDishes = [];
                    nutritionTotals = { calories: 0.0, protein: 0.0, fat: 0.0, carb: 0.0 };
                    
                    // 重置UI
                    document.getElementById('emptyResults').style.display = 'flex';
                    document.getElementById('resultsContainer').style.display = 'none';
                    document.getElementById('confirmResultsBtn').style.display = 'none';
                    document.getElementById('nutritionSummary').style.display = 'none';
                    
                    // 重置图片上传
                    document.getElementById('dishImage').value = '';
                    
                    // 恢复默认预览
                    stopCamera();
                    cameraBtn.innerHTML = '<i class="fas fa-camera me-1"></i>拍照';
                    const previewElements = imagePreview.querySelectorAll('i, p');
                    previewElements.forEach(el => el.style.display = 'block');
                    const existingImg = imagePreview.querySelector('img');
                    if (existingImg) {
                        existingImg.remove();
                    }
                } else {
                    alert('保存失败：' + data.message);
                }
            })
            .catch(err => {
                alert('保存请求失败，请检查网络！');
                console.error("保存记录错误：", err);
            });
    }
</script>
{% endblock %}