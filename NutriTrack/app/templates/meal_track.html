{% extends "base.html" %}

{% block title %}用餐追踪{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-3"><i class="fas fa-utensils me-2"></i>用餐追踪</h2>
    </div>
</div>

<!-- Meal Monitor Section (Matches Figure 1) -->
<div class="card mb-5">
    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
        <h5 class="mb-0 fw-bold">取餐监控</h5>
        <div class="d-flex align-items-center">
            <span class="me-3">状态: <span class="text-success fw-bold">正在取餐</span></span>
            <button class="btn btn-outline-secondary btn-sm" id="pauseBtn">暂停取餐</button>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Left: Weight Log -->
            <div class="col-md-4 border-end">
                <h6 class="text-muted mb-3">重量变化记录</h6>
                <div class="list-group list-group-flush" id="weightLog" style="height: 300px; overflow-y: auto;">
                    <!-- Logs will be populated here -->
                    <div class="d-flex justify-content-between py-2 border-bottom">
                        <span class="text-muted">12:05</span>
                        <span class="text-success fw-bold">+120g</span>
                    </div>
                    <div class="d-flex justify-content-between py-2 border-bottom">
                        <span class="text-muted">12:07</span>
                        <span class="text-success fw-bold">+80g</span>
                    </div>
                </div>
            </div>
            
            <!-- Right: Real-time Chart -->
            <div class="col-md-8">
                <h6 class="text-muted mb-3">实时重量图表</h6>
                <div style="height: 300px;">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-success btn-lg px-5" id="finishMealBtn">
                <i class="fas fa-check-circle me-2"></i>完成取餐
            </button>
        </div>
    </div>
</div>

<!-- Dish Detection Section -->
<div class="card mb-4">
    <div class="card-header"><i class="fas fa-camera me-2"></i>菜品识别与营养计算</div>
    <div class="card-body">
        
        <ul class="nav nav-tabs mb-3" id="detectionMethod" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">上传图片</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button" role="tab">使用摄像头</button>
            </li>
        </ul>

        <div class="tab-content mb-4" id="detectionMethodContent">
            <!-- Upload Tab -->
            <div class="tab-pane fade show active" id="upload" role="tabpanel">
                <div class="mb-3">
                    <input type="file" class="form-control" id="dishImage" accept="image/*">
                </div>
                <button class="btn btn-primary" onclick="detectDish('upload')">识别菜品</button>
            </div>
            
            <!-- Camera Tab -->
            <div class="tab-pane fade" id="camera" role="tabpanel">
                <div class="text-center mb-3">
                    <video id="video" width="100%" style="max-width: 500px; border-radius: 8px; display:none;" autoplay></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <div id="cameraPlaceholder" class="bg-light p-5 rounded mb-3" style="cursor: pointer;" onclick="startCamera()">
                        <i class="fas fa-camera fa-3x text-muted"></i>
                        <p class="mt-2 text-muted">点击开启摄像头</p>
                    </div>
                    <button class="btn btn-primary mt-2" id="captureBtn" style="display:none;" onclick="captureAndDetect()">拍照并识别</button>
                </div>
            </div>
        </div>
        <div id="uploadedImageContainer" style="display:none; margin-bottom: 20px;">
            <h5 class="border-bottom pb-2 mb-3">上传图片</h5>
            <img id="uploadedImage" src="" alt="上传的菜品图片" style="max-width: 500px; border-radius: 8px;"/>
        </div>
        <!-- Results Area -->
        <div id="detectionResults" style="display:none;">
            <h5 class="border-bottom pb-2 mb-3">识别结果</h5>

<div class="table-responsive">
    <table class="table align-middle table-hover">
        <thead class="table-light">
            <tr>
                <th>菜品名称</th>
                <th>重量 (g)</th>
                <th>置信度</th>
                <th>热量 (kcal)</th>
                <th>营养占比</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
    </table>
</div>
            
            <div class="row mt-4">
<!-- 替换原有营养总览卡片 (约120-150行) -->
<div class="col-md-6">
    <div class="card bg-light border-0">
        <div class="card-body">
            <h5 class="card-title text-success mb-3">营养总览</h5>

            <!-- 新增环形进度图 -->
            <div class="d-flex justify-content-center mb-4">
                <canvas id="nutritionChart" width="180" height="180"></canvas>
            </div>

            <!-- 营养数据列表 -->
            <div class="d-flex justify-content-between mb-2">
                <span>总热量:</span>
                <span class="fw-bold"><span id="totalCal">0</span> kcal</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>蛋白质:</span>
                <span class="fw-bold"><span id="totalProt">0</span> g</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>脂肪:</span>
                <span class="fw-bold"><span id="totalFat">0</span> g</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>碳水化合物:</span>
                <span class="fw-bold"><span id="totalCarb">0</span> g</span>
            </div>

            <!-- 食材明细切换按钮 -->
            <button class="btn btn-sm btn-outline-success mt-3 w-100" onclick="toggleIngredientDetails()">
                <i class="fas fa-list me-1"></i>查看食材明细
            </button>

            <!-- 食材明细展示区 (默认隐藏) -->
            <div id="ingredientDetails" style="margin-top: 15px; display: none; max-height: 200px; overflow-y: auto; border-top: 1px dashed #ddd; padding-top: 10px;">
                <h6 class="text-muted mb-2">食材营养贡献</h6>
                <div id="ingredientList"></div>
            </div>
        </div>
    </div>
</div>
                <div class="col-md-6 d-flex align-items-end justify-content-end">
                    <div class="w-100">
                        <label for="mealType" class="form-label">用餐时段</label>
                        <select class="form-select mb-3" id="mealType">
                            <option value="1">早餐</option>
                            <option value="2">午餐</option>
                            <option value="3">晚餐</option>
                        </select>
                        <button class="btn btn-success w-100 py-2" onclick="saveRecord()">
                            <i class="fas fa-save me-2"></i>保存记录
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Chart & Monitor Logic ---
    const ctx = document.getElementById('weightChart').getContext('2d');
    const weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['12:00', '12:05', '12:07', '12:09', '12:10'],
            datasets: [{
                label: '重量 (g)',
                data: [0, 120, 200, 250, 350],
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // --- Camera Logic ---
    let videoStream = null;
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');

    async function startCamera() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = videoStream;
            video.style.display = 'block';
            captureBtn.style.display = 'inline-block';
            cameraPlaceholder.style.display = 'none';
        } catch (err) {
            console.error("Error accessing camera: ", err);
            alert("无法访问摄像头，请检查权限。");
        }
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            cameraPlaceholder.style.display = 'block';
        }
    }

    // Stop camera when switching tabs
    document.getElementById('upload-tab').addEventListener('click', stopCamera);

    function captureAndDetect() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        canvas.toBlob(function(blob) {
            detectDish('camera', blob);
        }, 'image/jpeg');
    }

    // --- Detection Logic ---
    let currentDishes = [];
    let nutritionTotals = {};

    function detectDish(source, blob = null) {
    const formData = new FormData();

    if (source === 'upload') {
        const fileInput = document.getElementById('dishImage');
        if (fileInput.files.length === 0) return alert('请选择一张图片');
        formData.append('image', fileInput.files[0]);
    } else {
        if (!blob) return alert('拍照失败');
        formData.append('image', blob, 'capture.jpg');
    }

    fetch("{{ url_for('meal_track.detect_dish') }}", {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 显示上传的图片
            const imgContainer = document.getElementById('uploadedImageContainer');
            const imgElement = document.getElementById('uploadedImage');
            imgElement.src = data.image_url;
            imgContainer.style.display = 'block';

            // 显示检测结果
            displayResults(data.results);
            calculateNutrition(data.results);
        } else {
            alert(data.message);
            // 即使出错也显示图片
            if (data.image_url) {
                const imgContainer = document.getElementById('uploadedImageContainer');
                const imgElement = document.getElementById('uploadedImage');
                imgElement.src = data.image_url;
                imgContainer.style.display = 'block';
            }
        }
    })
    .catch(err => alert('识别请求失败'));
}


    function displayResults(results) {
        const tbody = document.getElementById('resultsTable');
        tbody.innerHTML = '';
        currentDishes = results;
        
        results.forEach((dish, index) => {
            const row = `<tr>
                <td>${dish.dish_name}</td>
                <td><input type="number" class="form-control form-control-sm" style="width: 80px" value="${dish.weight}" onchange="updateWeight(${index}, this.value)"></td>
                <td>${(dish.confidence * 100).toFixed(1)}%</td>
                <td id="cal-${index}">...</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="removeDish(${index})"><i class="fas fa-trash"></i></button></td>
            </tr>`;
            tbody.innerHTML += row;
        });
        
        document.getElementById('detectionResults').style.display = 'block';
    }

    function updateWeight(index, value) {
        currentDishes[index].weight = parseFloat(value);
        calculateNutrition(currentDishes);
    }

    function removeDish(index) {
        currentDishes.splice(index, 1);
        displayResults(currentDishes);
        calculateNutrition(currentDishes);
    }

    function calculateNutrition(dishes) {
        fetch("{{ url_for('meal_track.calculate_nutrition') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({dishes: dishes})
        })
        .then(response => response.json())
        .then(data => {
            nutritionTotals = data.total;
            
            // Update individual rows
            data.details.forEach((detail, idx) => {
                const calCell = document.getElementById(`cal-${idx}`);
                if(calCell) calCell.innerText = detail.calories.toFixed(1);
            });

            // Update totals
            document.getElementById('totalCal').innerText = data.total.calories.toFixed(1);
            document.getElementById('totalProt').innerText = data.total.protein.toFixed(1);
            document.getElementById('totalFat').innerText = data.total.fat.toFixed(1);
            document.getElementById('totalCarb').innerText = data.total.carb.toFixed(1);
        });
    }

    function saveRecord() {
    const mealType = document.getElementById('mealType').value;
    const saveBtn = document.querySelector('button[onclick="saveRecord()"]');
    const originalText = saveBtn.innerHTML;

    // 禁用按钮并显示加载
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>保存中...';

    fetch("{{ url_for('meal_track.save_meal_record') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            meal_type: mealType,
            dish_list: currentDishes,
            totals: nutritionTotals
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 显示成功动画
            saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>保存成功';
            saveBtn.classList.remove('btn-success');
            saveBtn.classList.add('btn-outline-success');

            // 2秒后跳转回仪表盘
            setTimeout(() => {
                window.location.href = "{{ url_for('dashboard.index') }}";
            }, 2000);
        } else {
            alert(data.message);
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    })
    .catch(err => {
        alert('保存失败，请重试');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}


    // 初始化营养环形图
let nutritionChart = null;
function initNutritionChart() {
    const ctx = document.getElementById('nutritionChart').getContext('2d');
    nutritionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['蛋白质', '脂肪', '碳水化合物'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#28a745', '#ffc107', '#17a2b8'],
                borderWidth: 0,
                hoverOffset: 5
            }]
        },
        options: {
            cutout: '70%',
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value}g (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// 切换食材明细显示切换
function toggleIngredientDetails() {
    const detailsDiv = document.getElementById('ingredientDetails');
    detailsDiv.style.display = detailsDiv.style.display === 'none' ? 'block' : 'none';
}

// 更新菜品列表展示（增强版）
function displayResults(results) {
    const tbody = document.getElementById('resultsTable');
    tbody.innerHTML = '';
    currentDishes = results;

    results.forEach((dish, index) => {
        // 计算单菜品占比（基于当前总热量）
        const totalCal = currentDishes.reduce((sum, d) => sum + (d.calories || 0), 0);
        const percentage = totalCal > 0 ? Math.round((dish.calories / totalCal) * 100) : 0;

        const row = `<tr>
            <td>
                <div class="d-flex align-items-center">
                    <i class="fas fa-utensils text-success me-2"></i>
                    <span>${dish.dish_name}</span>
                </div>
            </td>
            <td><input type="number" class="form-control form-control-sm" style="width: 80px" value="${dish.weight}" onchange="updateWeight(${index}, this.value)"></td>
            <td>
                <div class="d-flex align-items-center">
                    <span class="me-2">${(dish.confidence * 100).toFixed(1)}%</span>
                    <div class="progress" style="width: 80px; height: 6px;">
                        <div class="progress-bar bg-success" style="width: ${(dish.confidence * 100)}%"></div>
                    </div>
                </div>
            </td>
            <td id="cal-${index}">${dish.calories ? dish.calories.toFixed(1) : '...'}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="progress" style="width: 100px; height: 6px;">
                        <div class="progress-bar bg-primary" style="width: ${percentage}%"></div>
                    </div>
                    <span class="ms-2 text-sm">${percentage}%</span>
                </div>
            </td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeDish(${index})"><i class="fas fa-trash"></i></button></td>
        </tr>`;
        tbody.innerHTML += row;
    });

    document.getElementById('detectionResults').style.display = 'block';
}

// 优化营养计算回调（更新图表和明细）
function calculateNutrition(dishes) {
    fetch("{{ url_for('meal_track.calculate_nutrition') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({dishes: dishes})
    })
    .then(response => response.json())
    .then(data => {
        nutritionTotals = data.total;

        // 更新单个菜品热量
        data.details.forEach((detail, idx) => {
            const calCell = document.getElementById(`cal-${idx}`);
            if(calCell) calCell.innerText = detail.calories.toFixed(1);
        });

        // 更新总营养数据
        document.getElementById('totalCal').innerText = data.total.calories.toFixed(1);
        document.getElementById('totalProt').innerText = data.total.protein.toFixed(1);
        document.getElementById('totalFat').innerText = data.total.fat.toFixed(1);
        document.getElementById('totalCarb').innerText = data.total.carb.toFixed(1);

        // 更新环形图
        if (nutritionChart) {
            nutritionChart.data.datasets[0].data = [
                data.total.protein,
                data.total.fat,
                data.total.carb
            ];
            nutritionChart.update();
        }

        // 更新食材明细
        const ingredientList = document.getElementById('ingredientList');
        ingredientList.innerHTML = '';
        data.details.forEach(dish => {
            if (dish.ingredients.length === 0) return;

            const dishGroup = document.createElement('div');
            dishGroup.className = 'mb-3';
            dishGroup.innerHTML = `
                <div class="fw-medium text-success">${dish.dish_name}</div>
                <ul class="list-group list-group-sm ms-3 mt-1">
                    ${dish.ingredients.map(ing => `
                        <li class="list-group-item d-flex justify-content-between p-1">
                            <small>${ing.name} (${ing.amount}g)</small>
                            <small class="text-muted">${ing.calories} kcal</small>
                        </li>
                    `).join('')}
                </ul>
            `;
            ingredientList.appendChild(dishGroup);
        });
    });
}

// 页面加载时初始化图表
window.onload = function() {
    initNutritionChart();
    // 其他初始化逻辑...
};
</script>
{% endblock %}
